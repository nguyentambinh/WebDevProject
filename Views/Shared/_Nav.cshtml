@model IEnumerable<QLNSVATC.Models.MENU>

@{
    var menus = Model.ToList();
    var roots = menus.Where(x => x.ParentId == null).OrderBy(x => x.OrderNumber).ToList();

    string themeColor = ViewBag.ThemeColor as string ?? "#121212";
    string fontFamily = ViewBag.FontFamily as string ?? "Inter";
    int fontSize = ViewBag.FontSize != null ? (int)ViewBag.FontSize : 20;
    if (fontSize <= 0) { fontSize = 20; }

    string currentLang = ViewBag.CurrentLang as string ?? "vi_VN";
    bool isDarkMode = ViewBag.DarkMode != null ? (bool)ViewBag.DarkMode : false;

    string textColor = isDarkMode ? "#ffffff" : "#000000";
    string gradient1 = isDarkMode ? "#000000" : "#ffffff";
    string gradient2 = isDarkMode ? "#ffffff" : "#000000";
    string gradientDirection = isDarkMode ? "to left" : "to right";

    string userName = Session["FullName"] as string ?? null;
    var role = Session["Role"] as string ?? "";
    bool isAdmin = string.Equals(role, "AD", StringComparison.OrdinalIgnoreCase);

    string homeUrl;

    switch (role)
    {
        case "HR":
            homeUrl = Url.Action("Index", "Home", new { area = "HR" });
            break;
        case "FN":
            homeUrl = Url.Action("Index", "Home", new { area = "FN" });
            break;
        case "AD":
            homeUrl = Url.Action("Index", "Home", new { area = "AD" });
            break;
        case "OF":
            homeUrl = Url.Action("Index", "Home", new { area = "OF" });
            break;
        case "EM":
            homeUrl = Url.Action("Index", "Home", new { area = "EM" });
            break;
        default:
            homeUrl = Url.Action("Index", "Home", new { area = "" });
            break;
    }

    var langAccount = new Dictionary<string, string>
{
        { "vi_VN", userName == null ? "TÀI KHOẢN" : $"XIN CHÀO, {userName.ToUpper()}" },
        { "en_US", userName == null ? "ACCOUNT" : $"HELLO, {userName.ToUpper()}" },
        { "jp_JP", userName == null ? "アカウント" : $"こんにちは, {userName}" },
        { "kr_KR", userName == null ? "계정" : $"환영합니다, {userName}" },
        { "cn_CN", userName == null ? "账户" : $"您好, {userName}" }
    };

    var langLogin = new Dictionary<string, string>
{
        { "vi_VN", "Đăng nhập" },
        { "en_US", "Login" },
        { "jp_JP", "ログイン" },
        { "kr_KR", "로그인" },
        { "cn_CN", "登录" }
    };

    var langRegister = new Dictionary<string, string>
{
        { "vi_VN", "Đăng ký" },
        { "en_US", "Register" },
        { "jp_JP", "新規登録" },
        { "kr_KR", "회원가입" },
        { "cn_CN", "注册" }
    };

    var langProfile = new Dictionary<string, string>
{
        { "vi_VN", "Hồ sơ" },
        { "en_US", "Profile" },
        { "jp_JP", "プロフィール" },
        { "kr_KR", "프로필" },
        { "cn_CN", "资料" }
    };

    var langLogout = new Dictionary<string, string>
{
        { "vi_VN", "Đăng xuất" },
        { "en_US", "Logout" },
        { "jp_JP", "ログアウト" },
        { "kr_KR", "로그아웃" },
        { "cn_CN", "退出登录" }
    };

    string accountLabel = langAccount.ContainsKey(currentLang) ? langAccount[currentLang] : langAccount["vi_VN"];
    string loginLabel = langLogin.ContainsKey(currentLang) ? langLogin[currentLang] : langLogin["vi_VN"];
    string registerLabel = langRegister.ContainsKey(currentLang) ? langRegister[currentLang] : langRegister["vi_VN"];
    string profileLabel = langProfile.ContainsKey(currentLang) ? langProfile[currentLang] : langProfile["vi_VN"];
    string logoutLabel = langLogout.ContainsKey(currentLang) ? langLogout[currentLang] : langLogout["vi_VN"];

    string currentFontCode = ViewBag.FontCode as string;
    if (string.IsNullOrEmpty(currentFontCode))
    {
        var lower = fontFamily.ToLower();
        if (lower.Contains("arial"))
        {
            currentFontCode = "arial";
        }
        else if (lower.Contains("roboto"))
        {
            currentFontCode = "roboto";
        }
        else
        {
            currentFontCode = "inter";
        }
    }

    string uiSettingsTitle;
    string uiThemeColorLbl;
    string uiTypeLbl;
    string uiTypeDarkLbl;
    string uiTypeLightLbl;
    string uiLanguageLbl;
    string uiFontFamilyLbl;
    string uiTextSizeLbl;
    string uiSaveBtnLbl;

    switch (currentLang)
    {
        case "en_US":
            uiSettingsTitle = "UI SETTINGS";
            uiThemeColorLbl = "Theme color";
            uiTypeLbl = "Theme type";
            uiTypeDarkLbl = "Dark";
            uiTypeLightLbl = "Light";
            uiLanguageLbl = "Language";
            uiFontFamilyLbl = "Font family";
            uiTextSizeLbl = "Text size";
            uiSaveBtnLbl = "Save changes";
            break;
        case "jp_JP":
            uiSettingsTitle = "UI設定";
            uiThemeColorLbl = "テーマカラー";
            uiTypeLbl = "テーマタイプ";
            uiTypeDarkLbl = "ダーク";
            uiTypeLightLbl = "ライト";
            uiLanguageLbl = "言語";
            uiFontFamilyLbl = "フォント";
            uiTextSizeLbl = "文字サイズ";
            uiSaveBtnLbl = "変更を保存";
            break;
        case "kr_KR":
            uiSettingsTitle = "UI 설정";
            uiThemeColorLbl = "테마 색상";
            uiTypeLbl = "테마 타입";
            uiTypeDarkLbl = "다크";
            uiTypeLightLbl = "라이트";
            uiLanguageLbl = "언어";
            uiFontFamilyLbl = "글꼴";
            uiTextSizeLbl = "글자 크기";
            uiSaveBtnLbl = "변경사항 저장";
            break;
        case "cn_CN":
            uiSettingsTitle = "界面设置";
            uiThemeColorLbl = "主题颜色";
            uiTypeLbl = "主题类型";
            uiTypeDarkLbl = "深色";
            uiTypeLightLbl = "浅色";
            uiLanguageLbl = "语言";
            uiFontFamilyLbl = "字体";
            uiTextSizeLbl = "字号";
            uiSaveBtnLbl = "保存更改";
            break;
        default: // vi_VN
            uiSettingsTitle = "TÙY CHỈNH GIAO DIỆN";
            uiThemeColorLbl = "Màu chủ đề";
            uiTypeLbl = "Kiểu nền";
            uiTypeDarkLbl = "Tối (Black)";
            uiTypeLightLbl = "Sáng (White)";
            uiLanguageLbl = "Ngôn ngữ";
            uiFontFamilyLbl = "Phông chữ";
            uiTextSizeLbl = "Cỡ chữ";
            uiSaveBtnLbl = "Lưu thay đổi";
            break;
    }

    string themeRgbaColor = QLNSVATC.Helpers.ColorHelper.HexToRgba(themeColor, 0.95);
}

<style>
:root {
    --text-color: @textColor;
    --theme-color: @themeColor;
    --theme-rgba: @themeRgbaColor;
    --font: @fontFamily, sans-serif;
    --fz: @(fontSize)px;
    --g1: @gradient1;
    --g2: @gradient2;
    --gd: @gradientDirection;
}

nav {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    width: 100%;
    z-index: 9999;
    padding: 12px 0;
    box-shadow: 0 6px 18px rgba(0,0,0,.25);
    background-color: var(--theme-rgba);
    backdrop-filter: blur(14px);
    -webkit-backdrop-filter: blur(14px);
    border-bottom: 1px solid rgba(255, 255, 255, 0.12);
}

.nav-inner {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 20px;
    height: 58px;
    white-space: nowrap;
    font-family: var(--font);
}

.navbar-brand {
    align-items: center;
    font-size: 1.6em;
    font-weight: 700;
    color: var(--text-color);
    text-decoration: none;
    user-select: none;
}

.main-menu {
    list-style: none;
    display: flex;
    gap: 22px;
    align-items: center;
    margin: 0 !important;
    padding: 0 !important;
}

.main-menu > li {
    position: relative;
}

.main-menu > li > a {
    position: relative;
    padding: 12px 14px;
    color: var(--text-color);
    font-weight: 700;
    text-transform: uppercase;
    font-size: var(--fz);
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    transition: .25s;
}

.main-menu > li > a:hover {
    text-shadow: 0 0 8px var(--g1), 0 0 15px var(--g1);
}

.main-menu > li > a::after {
    content: "";
    position: absolute;
    bottom: 2px;
    left: 0;
    width: 100%;
    height: 3px;
    background: linear-gradient(var(--gd), var(--g1), var(--g2));
    border-radius: 50px;
    opacity: 0;
    transform: scaleX(0);
    transform-origin: left center;
    transition: .25s;
}

.main-menu > li > a:hover::after {
    opacity: 1;
    transform: scaleX(1);
}

.dropdown-menu {
    position: absolute;
    top: 100%;
    left: 5px;
    min-width: 180px;
    padding: 6px 0 10px;
    border-radius: 8px;
    background: #1a1c22;
    display: none;
    box-shadow: 0 10px 20px rgba(0,0,0,.35);
    z-index: 10000;
    margin-top: -10px;
}

.main-menu > li:hover > .dropdown-menu,
.dropdown-menu:hover {
    display: block;
}

.dropdown-menu a {
    padding: 8px 16px;
    display: block;
    color: #e2e6ff;
    text-decoration: none;
    white-space: nowrap;
    transition: .2s;
}

.dropdown-menu a:hover {
    background: rgba(255,255,255,0.08);
    text-shadow: 0 0 6px #fff;
}

/* MOBILE */
.menu-toggle {
    display: none;
    font-size: 32px;
    width: 30px;
    height: auto;
    text-align: center;
    color: var(--text-color);
    cursor: pointer;
    background: none;
    padding: 4px 10px;
    border-radius: 6px;
}

@@media (max-width:1200px) {
    nav {
        width: 100vw;
        width: 100%;
    }

    .nav-inner {
        padding: 0 12px;
    }

    .menu-toggle {
        display: block;
        position: relative;
        margin-right: -30px;
        transform: translateX(-100%);
        width: 70px;
    }

    .main-menu {
        overflow-x: hidden;
        flex-direction: column;
        align-items: flex-start;
        position: fixed;
        top: 82px;
        left: -60%;
        width: 55%;
        height: 100vh;
        background: var(--theme-color);
        padding-top: 80px;
        padding-left: 24px;
        transition: .35s;
        gap: 0;
        overflow-y: auto;
    }

    nav.open .main-menu {
        left: 0;
    }

    .main-menu > li > a {
        justify-content: flex-start;
        text-align: left;
        width: 100%;
        padding: 13px 13px;
        color: var(--text-color);
    }

    .dropdown-menu {
        position: relative;
        display: none;
        top: 5px;
        left: 0;
        background: var(--theme-color);
        color: var(--text-color);
        box-shadow: none;
        margin-top: -20px;
        padding: 4px 0 4px 16px;
    }

    .dropdown-menu a {
        padding: 6px 6px;
        color: var(--text-color);
    }

    .dropdown-menu a:hover {
        background: rgba(255,255,255,0.12);
        text-shadow: 0 0 6px var(--text-color);
    }
}

.settings-btn {
    font-size: 22px;
    cursor: pointer;
    color: var(--text-color);
    user-select: none;
    transition: .2s;
    margin-left: 10px;
}

.settings-btn:hover {
    animation: spinSlow 1s linear forwards;
}

@@keyframes spinSlow {
    from { transform: rotate(0deg); }
    to   { transform: rotate(720deg); }
}

@@media (max-width:1200px) {
    .settings-btn:hover {
        animation: none;
        transform: scale(0.9);
    }
}

.settings-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.55);
    display: none;
    z-index: 9998;
}

.settings-overlay.show {
    display: block;
}

.settings-panel {
    position: fixed;
    top: 50vh;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 330px;
    max-width: 95vw;
    max-height: 90vh;
    overflow-y: auto;
    background: #11141f;
    border-radius: 18px;
    padding: 24px 26px;
    opacity: 0;
    visibility: hidden;
    z-index: 9999;
    transition: opacity 0.25s ease, visibility 0.25s ease;
    box-shadow: 0 18px 45px rgba(0,0,0,0.4);
    color: #f5f5ff;
    font-family: var(--font);
}

.settings-panel.show {
    opacity: 1;
    visibility: visible;
}

.settings-panel form {
    display: flex;
    flex-direction: column;
    gap: 14px;
}

.settings-title {
    font-size: 20px;
    font-weight: 700;
    text-align: center;
    margin-bottom: 10px;
}

.settings-row {
    display: flex;
    flex-direction: column;
}

.settings-label {
    font-weight: 600;
    margin-bottom: 4px;
    font-size: 14px;
}

.settings-input {
    width: 100%;
    padding: 8px 10px;
    border-radius: 10px;
    background: #1a1e2b;
    border: 1px solid rgba(255,255,255,0.15);
    color: #f5f5ff;
    font-size: 14px;
    box-sizing: border-box;
}

.settings-input:focus {
    border-color: #40c9ff;
    outline: none;
    box-shadow: 0 0 0 1px #40c9ff;
}

.settings-input[type="number"]::-webkit-outer-spin-button,
.settings-input[type="number"]::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
}

.settings-input[type="number"] {
    -moz-appearance: textfield;
}

.settings-save {
    width: 100%;
    padding: 10px 0;
    margin-top: 4px;
    border-radius: 999px;
    border: none;
    cursor: pointer;
    font-size: 16px;
    font-weight: 600;
    font-family: var(--font);
    background: linear-gradient(135deg, #fceabb, #f8b500);
    color: #1a1a1a;
    box-shadow: 0 0 12px rgba(255, 209, 80, 0.4);
    transition: 0.3s;
}

.settings-save:hover {
    box-shadow: 0 0 20px rgba(255, 209, 80, 0.7);
    transform: translateY(-1px);
}

.settings-close {
    position: absolute;
    top: 8px;
    right: 10px;
    width: 26px;
    height: 26px;
    border-radius: 999px;
    border: none;
    background: transparent;
    color: #e5e7eb;
    font-size: 18px;
    cursor: pointer;
    line-height: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: 0.2s;
}

.settings-close:hover {
    background: rgba(255,255,255,0.08);
    transform: scale(1.05);
}

.msg-popup {
    position: fixed;
    top: -80px;
    left: 50%;
    transform: translateX(-50%);
    background: #222;
    color: #fff;
    padding: 14px 22px;
    border-radius: 8px;
    font-size: 15px;
    font-weight: 600;
    box-shadow: 0 6px 18px rgba(0,0,0,0.2);
    z-index: 9999;
    opacity: 0;
    transition: .35s;
}

.msg-popup.show {
    top: 20px;
    opacity: 1;
}

.msg-popup.success {
    background: #28a745;
}

.msg-popup.error {
    background: #dc3545;
}

#logo {
    height: 100%;
    max-height: 58px;
    width: auto;
}
</style>


<nav class="nav-neon">
    <div id="msgPopup" class="msg-popup"></div>

    <div class="nav-inner">
        <a class="navbar-brand" href="@homeUrl">
            <img id="logo" src="~/Content/Images/mainbg.png"
                 style="margin-right:8px;vertical-align:middle;" />
            TBT CENTER
        </a>

        <div class="menu-toggle" onclick="document.querySelector('nav').classList.toggle('open')">☰</div>

        <ul class="main-menu">
            @foreach (var root in roots)
            {
                var children = menus.Where(c => c.ParentId == root.MenuId).OrderBy(c => c.OrderNumber).ToList();

                if (children.Any())
                {
                    <li>
                        <a href="@root.MenuLink">@root.MenuName</a>
                        <ul class="dropdown-menu">
                            @foreach (var child in children)
                            {
                                <li style="list-style: none">
                                    <a href="@child.MenuLink">@child.MenuName</a>
                                </li>
                            }
                        </ul>
                    </li>
                }
                else
                {
                    <li><a href="@root.MenuLink">@root.MenuName</a></li>
                }
            }

            <!-- Account -->
            <li>
                <a href="#">@accountLabel</a>
                <ul class="dropdown-menu">
                    @if (userName == null)
                    {
                        <li style="list-style: none">@Html.ActionLink(loginLabel, "Login", "Account")</li>
                        <li style="list-style: none">@Html.ActionLink(registerLabel, "Register", "Account")</li>
                    }
                    else
                    {
                        <li style="list-style: none">@Html.ActionLink(profileLabel, "Profile", "Account")</li>
                        <li style="list-style: none">@Html.ActionLink(logoutLabel, "Logout", "Account")</li>
                    }
                </ul>
            </li>

            @if (!isAdmin)
            {
                <li class="settings-btn" onclick="openSettingCheck()">⚙</li>
            }
        </ul>

        @if (!isAdmin)
        {
            <div id="settingsOverlay" class="settings-overlay" onclick="closeSettingsPanel()"></div>

            <div id="settingsPanel" class="settings-panel" onclick="event.stopPropagation()">
                <button type="button" class="settings-close" onclick="closeSettingsPanel()">×</button>

                <h2 class="settings-title">@uiSettingsTitle</h2>

                <form action="/Shared/SaveSettings" method="post">
                    <div class="settings-row">
                        <label class="settings-label">@uiThemeColorLbl</label>
                        <input type="color" name="ThemeColor" class="settings-input" value="@themeColor" />
                    </div>

                    <div class="settings-row">
                        <label class="settings-label">@uiTypeLbl</label>
                        <select name="DarkMode" class="settings-input">
                            <option value="true" @(isDarkMode ? "selected" : "")>@uiTypeDarkLbl</option>
                            <option value="false" @(!isDarkMode ? "selected" : "")>@uiTypeLightLbl</option>
                        </select>
                    </div>

                    <div class="settings-row">
                        <label class="settings-label">@uiLanguageLbl</label>
                        <select name="LanguageCode" class="settings-input">
                            <option value="vi_VN" @(currentLang == "vi_VN" ? "selected" : "")>Việt Nam</option>
                            <option value="en_US" @(currentLang == "en_US" ? "selected" : "")>English</option>
                            <option value="jp_JP" @(currentLang == "jp_JP" ? "selected" : "")>日本語</option>
                            <option value="kr_KR" @(currentLang == "kr_KR" ? "selected" : "")>한국어</option>
                            <option value="cn_CN" @(currentLang == "cn_CN" ? "selected" : "")>中文</option>
                        </select>
                    </div>

                    <div class="settings-row">
                        <label class="settings-label">@uiFontFamilyLbl</label>
                        <select name="FontCode" class="settings-input">
                            <option value="inter" @(currentFontCode == "inter" ? "selected" : "")>Inter</option>
                            <option value="arial" @(currentFontCode == "arial" ? "selected" : "")>Arial</option>
                            <option value="roboto" @(currentFontCode == "roboto" ? "selected" : "")>Roboto</option>
                        </select>
                    </div>

                    <div class="settings-row">
                        <label class="settings-label">@uiTextSizeLbl</label>
                        <input type="number"
                               name="FontSize"
                               class="settings-input"
                               min="10"
                               max="24"
                               value="@fontSize" />
                    </div>

                    <button type="submit" class="settings-save">@uiSaveBtnLbl</button>
                </form>
            </div>
        }
    </div>
</nav>

<script>
    function openSettingsPanel() {
        var overlay = document.getElementById("settingsOverlay");
        var panel = document.getElementById("settingsPanel");
        if (!overlay || !panel) return;
        overlay.classList.add("show");
        panel.classList.add("show");
    }

    function closeSettingsPanel() {
        var overlay = document.getElementById("settingsOverlay");
        var panel = document.getElementById("settingsPanel");
        if (!overlay || !panel) return;
        overlay.classList.remove("show");
        panel.classList.remove("show");
    }

    function openSettingCheck() {
        var user = "@(Session["UserId"] ?? "")";
        if (!user || user.trim() === "") {
            window.location.href = "/Account/Login?returnUrl=/";
            return;
        }
        openSettingsPanel();
    }

    function showPopup(type, message) {
        const popup = document.getElementById("msgPopup");
        popup.className = "msg-popup " + type + " show";
        popup.innerText = message;
        setTimeout(() => popup.classList.remove("show"), 2500);
    }

    document.addEventListener("DOMContentLoaded", function () {
        var rootItems = document.querySelectorAll(".main-menu > li");

        rootItems.forEach(function (li) {
            var link = li.querySelector("a");
            if (!link) return;

            var submenu = li.querySelector(".dropdown-menu");

            link.addEventListener("click", function (e) {
                if (!submenu) return;

                if (window.innerWidth > 1200) {
                    e.preventDefault();
                    return;
                } else {
                    e.preventDefault();
                    e.stopPropagation();

                    document.querySelectorAll(".dropdown-menu").forEach(function (menu) {
                        if (menu !== submenu) {
                            menu.style.display = "none";
                        }
                    });

                    submenu.style.display = submenu.style.display === "block" ? "none" : "block";
                }
            });
        });

        document.addEventListener("click", function () {
            if (window.innerWidth > 1200) return;
            document.querySelectorAll(".dropdown-menu")
                .forEach(function (menu) { menu.style.display = "none"; });
        });
    });
</script>
