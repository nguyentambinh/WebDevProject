@using System.Linq
@using QLNSVATC.Models
@using QLNSVATC.Helpers
@model QLNSVATC.Areas.FN.Data.FN_Models.ServiceRevenueViewModel

@{
    Layout = "~/Areas/FN/Views/Shared/_LayoutFN.cshtml";

    var st = ViewBag.Settings as UserViewBagModel;

    string theme = st?.ThemeHex ?? "#22c55e";
    bool dark = st?.DarkMode ?? true;

    string bg = dark ? "#020617" : "#f5f7fb";
    string cardBg = dark ? "#020617" : "#ffffff";
    string textColor = dark ? "#e5e7eb" : "#0f172a";
    string border = dark ? "#1e293b" : "#e2e8f0";

    string font = !string.IsNullOrEmpty(st?.FontFamily)
        ? st.FontFamily
        : "Inter, system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif";

    int fz = st?.FontSize ?? 16;

    string lang = ViewBag.CurrentLang as string ?? st?.Lang ?? "vi_VN";
    ViewBag.CurrentLang = lang;

    Func<Dictionary<string, string>, string> L = dict =>
    {
        if (dict.ContainsKey(lang)) return dict[lang];
        if (dict.ContainsKey("en_US")) return dict["en_US"];
        return dict.Values.First();
    };

    var txtTitle = L(new Dictionary<string, string> {
        { "vi_VN", "Doanh thu từ dịch vụ" },
        { "en_US", "Service revenue overview" },
        { "jp_JP", "サービス収益概要" },
        { "kr_KR", "서비스 매출 요약" },
        { "cn_CN", "服务收入概览" }
    });

    var txtTotalRevenue = L(new Dictionary<string, string> {
        { "vi_VN", "Tổng doanh thu dịch vụ" },
        { "en_US", "Total service revenue" }
    });

    var txtServiceOrders = L(new Dictionary<string, string> {
        { "vi_VN", "Số giao dịch dịch vụ" },
        { "en_US", "Service orders" }
    });

    var txtAvgOrder = L(new Dictionary<string, string> {
        { "vi_VN", "Giá trị TB / giao dịch" },
        { "en_US", "Average order value" }
    });

    // TIÊU ĐỀ BIỂU ĐỒ MỚI
    var txtChartTitle = L(new Dictionary<string, string> {
        { "vi_VN", "Cơ cấu doanh thu theo loại dịch vụ" },
        { "en_US", "Revenue by service type" }
    });

    var txtChartSeries = L(new Dictionary<string, string> {
        { "vi_VN", "Doanh thu" },
        { "en_US", "Revenue" }
    });

    var txtTopServices = L(new Dictionary<string, string> {
        { "vi_VN", "Top loại dịch vụ theo doanh thu" },
        { "en_US", "Top service types by revenue" }
    });

    var txtColServiceType = L(new Dictionary<string, string> {
        { "vi_VN", "Loại dịch vụ" },
        { "en_US", "Service type" }
    });

    var txtColOrders = L(new Dictionary<string, string> {
        { "vi_VN", "Số giao dịch" },
        { "en_US", "Orders" }
    });

    var txtColRevenue = L(new Dictionary<string, string> {
        { "vi_VN", "Doanh thu" },
        { "en_US", "Revenue" }
    });

    // DỮ LIỆU CHO BIỂU ĐỒ TRÒN – DÙNG TOP SERVICES
    var svcTypeLabels = Model.TopServices
        .Select(s => s.ServiceType)
        .ToList();

    var svcTypeRevenues = Model.TopServices
        .Select(s => s.Revenue)
        .ToList();
}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="rev-page">
    <div class="rev-header">
        <div>
            <h2>@txtTitle</h2>
            <p class="sub">
                @Model.FromDate.ToString("dd/MM/yyyy") – @Model.ToDate.ToString("dd/MM/yyyy")
            </p>
        </div>
        <a class="btn btn-sm btn-primary"
           href="@Url.Action("ExportServiceRevenue", "Revenue", new { area = "FN", from = Model.FromDate, to = Model.ToDate })">
            Xuất báo cáo Excel
        </a>
    </div>

    <div class="rev-top-cards">
        <div class="card primary">
            <p class="label">@txtTotalRevenue</p>
            <h3 class="value">@Model.TotalRevenue.ToShortCurrency(lang)</h3>
        </div>
        <div class="card">
            <p class="label">@txtServiceOrders</p>
            <h3 class="value">@Model.ServiceOrders.FormatNumber(lang)</h3>
        </div>
        <div class="card">
            <p class="label">@txtAvgOrder</p>
            <h3 class="value">@Model.AverageOrderValue.ToShortCurrency(lang)</h3>
        </div>
    </div>

    <div class="rev-main-grid">
        <!-- PANEL BIỂU ĐỒ TRÒN -->
        <div class="panel wide">
            <div class="panel-header">
                <span class="panel-title">@txtChartTitle</span>
            </div>
            <div class="chart-wrap">
                <canvas id="svcPieChart"></canvas>
            </div>
        </div>

        <!-- BẢNG TOP LOẠI DỊCH VỤ -->
        <div class="panel">
            <div class="panel-header">
                <span class="panel-title">@txtTopServices</span>
            </div>

            @if (Model.TopServices.Any())
            {
                <table class="rev-table">
                    <thead>
                        <tr>
                            <th>@txtColServiceType</th>
                            <th class="right">@txtColOrders</th>
                            <th class="right">@txtColRevenue</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var s in Model.TopServices)
                        {
                            <tr>
                                <td>@s.ServiceType</td>
                                <td class="right">@s.Count.FormatNumber(lang)</td>
                                <td class="right">@s.Revenue.ToShortCurrency(lang)</td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
            else
            {
                <div class="empty">No service data.</div>
            }
        </div>
    </div>
</div>

<style>
    :root {
        --bg: @bg;
        --card: @cardBg;
        --text: @textColor;
        --border: @border;
        --accent: @theme;
        --font: @font;
        --fz: @(fz)px;
    }
</style>

<link href="~/Areas/FN/Data/CSS/Revenue/ServiceREV.css" rel="stylesheet" />

<script>
    (function () {
        const labels = @Html.Raw(Json.Encode(svcTypeLabels));
        const data = @Html.Raw(Json.Encode(svcTypeRevenues));

        if (!labels || !labels.length) return;

        const ctx = document.getElementById('svcPieChart');
        if (!ctx) return;

        const rootStyles = getComputedStyle(document.documentElement);
        const accent = rootStyles.getPropertyValue('--accent').trim() || '#22c55e';

        const palette = [
            accent,
            'rgba(59,130,246,0.9)',
            'rgba(244,114,182,0.9)',
            'rgba(234,179,8,0.9)',
            'rgba(56,189,248,0.9)',
            'rgba(52,211,153,0.9)',
            'rgba(249,115,22,0.9)'
        ];

        const colors = labels.map((_, i) => palette[i % palette.length]);

        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    label: '@txtChartSeries',
                    data: data,
                    backgroundColor: colors,
                    borderWidth: 0,
                    hoverOffset: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '55%',
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            boxWidth: 10,
                            boxHeight: 10,
                            padding: 10,
                            font: { size: 11 }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function (ctx) {
                                const val = ctx.parsed;
                                const total = ctx.chart.data.datasets[0].data
                                    .reduce(function (a, b) { return a + b; }, 0);
                                const pct = total ? (val * 100 / total).toFixed(1) : 0;
                                return ctx.label + ': ' + val.toLocaleString() + ' (' + pct + '%)';
                            }
                        }
                    }
                }
            }
        });
    })();
</script>
