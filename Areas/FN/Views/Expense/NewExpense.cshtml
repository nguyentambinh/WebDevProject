@using System.Collections.Generic
@using System.Linq
@using QLNSVATC.Models
@model QLNSVATC.Areas.FN.Data.FN_Models.NewExpenseViewModel

@{
    Layout = "~/Areas/FN/Views/Shared/_LayoutFN.cshtml";

    var st = ViewBag.Settings as UserViewBagModel;

    string theme = st?.ThemeHex ?? "#22c55e";
    bool dark = st?.DarkMode ?? true;

    string bg = dark ? "#020617" : "#f5f5f5";
    string cardBg = dark ? "#020617" : "#ffffff";
    string text = dark ? "#e5e7eb" : "#020617";
    string textSoft = dark ? "#9ca3af" : "#6b7280";
    string border = dark ? "#1f2937" : "#d1d5db";

    string font = !string.IsNullOrEmpty(st?.FontFamily)
        ? st.FontFamily
        : "Inter, system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif";

    int fz = st?.FontSize ?? 16;
    string lang = ViewBag.CurrentLang as string ?? st?.Lang ?? "en_US";

    Func<Dictionary<string, string>, string> L = d =>
    {
        if (d.ContainsKey(lang)) return d[lang];
        if (d.ContainsKey("en_US")) return d["en_US"];
        return d.Values.First();
    };

    var tTitle = new Dictionary<string, string> {
        { "vi_VN","Thêm chi phí" },
        { "en_US","New expense" },
        { "jp_JP","費用を追加" },
        { "kr_KR","비용 추가" },
        { "cn_CN","新增费用" }
    };

    var tSub = new Dictionary<string, string> {
        { "vi_VN","Ghi nhận chi phí cho từng dự án / nguyên vật liệu." },
        { "en_US","Record a new expense for a project or material." },
        { "jp_JP","プロジェクトまたは原材料に対する費用を登録します。" },
        { "kr_KR","프로젝트 / 원자재 비용을 등록합니다." },
        { "cn_CN","为项目或原材料记录一笔新费用。" }
    };

    var tProject = new Dictionary<string, string> {
        { "vi_VN","Dự án" },
        { "en_US","Project" },
        { "jp_JP","プロジェクト" },
        { "kr_KR","프로젝트" },
        { "cn_CN","项目" }
    };

    var tCategory = new Dictionary<string, string> {
        { "vi_VN","Loại chi phí" },
        { "en_US","Category" },
        { "jp_JP","区分" },
        { "kr_KR","비용 구분" },
        { "cn_CN","费用类型" }
    };

    var tMaterialName = new Dictionary<string, string> {
        { "vi_VN","Tên nguyên vật liệu (nếu là chi phí nhập NVL)" },
        { "en_US","Material name (for Material type)" },
        { "jp_JP","原材料名（原材料購入の場合）" },
        { "kr_KR","원자재 명 (원자재 매입 시)" },
        { "cn_CN","原材料名称（原材料采购时）" }
    };

    var tDate = new Dictionary<string, string> {
        { "vi_VN","Ngày" },
        { "en_US","Date" },
        { "jp_JP","日付" },
        { "kr_KR","날짜" },
        { "cn_CN","日期" }
    };

    var tTotal = new Dictionary<string, string> {
        { "vi_VN","Số tiền" },
        { "en_US","Total" },
        { "jp_JP","金額" },
        { "kr_KR","금액" },
        { "cn_CN","金额" }
    };

    var tFactor = new Dictionary<string, string> {
        { "vi_VN","Hệ số thay đổi (tùy chọn)" },
        { "en_US","Change factor (optional)" },
        { "jp_JP","変動係数（任意）" },
        { "kr_KR","변동 계수 (선택)" },
        { "cn_CN","变动系数（可选）" }
    };

    var tSave = new Dictionary<string, string> {
        { "vi_VN","Lưu" },
        { "en_US","Save" },
        { "jp_JP","保存" },
        { "kr_KR","저장" },
        { "cn_CN","保存" }
    };

    string TypeLabel(string code)
    {
        switch (code)
        {
            case "Material":
                return L(new Dictionary<string, string>{
                    { "vi_VN","Chi phí nhập nguyên vật liệu" },
                    { "en_US","Material purchase" },
                    { "jp_JP","原材料購入費" },
                    { "kr_KR","원자재 매입비" },
                    { "cn_CN","原材料采购费" }
                });
            case "Transport":
                return L(new Dictionary<string, string>{
                    { "vi_VN","Chi phí vận chuyển NVL" },
                    { "en_US","Material transport" },
                    { "jp_JP","原材料輸送費" },
                    { "kr_KR","원자재 운송비" },
                    { "cn_CN","原材料运输费" }
                });
            default:
                return L(new Dictionary<string, string>{
                    { "vi_VN","Chi phí dự án" },
                    { "en_US","Project expense" },
                    { "jp_JP","プロジェクト費用" },
                    { "kr_KR","프로젝트 비용" },
                    { "cn_CN","项目费用" }
                });
        }
    }
}

<div class="nexp-root">
    <div class="nexp-main">
        @using (Html.BeginForm("NewExpense", "Expense", FormMethod.Post, new { area = "FN" }))
        {
            @Html.AntiForgeryToken()

            <div class="nexp-form">
                <div class="nexp-header">
                    <div>
                        <h2 class="nexp-title">@L(tTitle)</h2>
                        <p class="nexp-sub">@L(tSub)</p>
                    </div>
                </div>

                @Html.ValidationSummary(true, "", new { @class = "field-error" })

                @if (TempData["FN_Success"] != null)
                {
                    <div class="alert-success">
                        @TempData["FN_Success"]
                    </div>
                }

                <div class="nexp-body nexp-body-single">
                    <div class="nexp-left-only">

                        <!-- Project -->
                        <div class="nexp-field">
                            <label>@L(tProject)*</label>
                            @Html.DropDownListFor(m => m.ProjectCode,
                                Model.ProjectOptions,
                                "--",
                                new { @class = "nexp-select" })
                            @Html.ValidationMessageFor(m => m.ProjectCode, "", new { @class = "field-error" })
                        </div>

                        <!-- Category / Type -->
                        <div class="nexp-field">
                            <label>@L(tCategory)*</label>
                            <select class="nexp-select" name="TypeCode">
                                @foreach (var opt in Model.TypeOptions)
                                {
                                    var selected = opt.Value == (Model.TypeCode ?? "Project") ? "selected" : null;
                                    <option value="@opt.Value" @selected>
                                        @TypeLabel(opt.Value)
                                    </option>
                                }
                            </select>
                        </div>

                        <!-- Material name (optional) -->
                        <div class="nexp-field">
                            <label>@L(tMaterialName)</label>
                            @Html.TextBoxFor(m => m.MaterialName, new { @class = "nexp-input" })
                            @Html.ValidationMessageFor(m => m.MaterialName, "", new { @class = "field-error" })
                        </div>

                        <!-- Date -->
                        <div class="nexp-field">
                            <label>@L(tDate)</label>
                            @Html.TextBoxFor(m => m.Date, "{0:yyyy-MM-dd}",
                                new { @class = "nexp-input", type = "date" })
                        </div>

                        <!-- Total -->
                        <div class="nexp-field">
                            <label>@L(tTotal)*</label>
                            @Html.TextBoxFor(m => m.Amount,
                                new { @class = "nexp-input", type = "number", step = "1000", min = "0" })
                            @Html.ValidationMessageFor(m => m.Amount, "", new { @class = "field-error" })
                        </div>

                        <!-- Change factor -->
                        <div class="nexp-field">
                            <label>@L(tFactor)</label>
                            @Html.TextBoxFor(m => m.ChangeFactor,
                                new { @class = "nexp-input", type = "number", step = "0.01" })
                        </div>

                    </div>
                </div>

                <div class="nexp-actions">
                    <button type="submit" class="nexp-btn-primary">
                        @L(tSave)
                    </button>
                </div>
            </div>
        }
    </div>
    <div id="nexp-success-modal" class="nexp-modal">
        <div class="nexp-modal-backdrop"></div>
        <div class="nexp-modal-box">
            <h3 class="nexp-modal-title">
                @(lang == "vi_VN" ? "Thêm chi phí thành công" : "Expense saved")
            </h3>
            <p class="nexp-modal-text">
                @(ViewBag.SuccessMessage ?? (lang == "vi_VN"
                ? "Chi phí đã được lưu."
                : "The expense has been saved."))
            </p>
            <button type="button" id="nexp-modal-ok" class="nexp-btn-primary nexp-modal-btn">
                @(lang == "vi_VN" ? "OK" : "OK")
            </button>
        </div>
    </div>
</div>

<link href="~/Areas/FN/Data/CSS/Expense/NewExpense.css" rel="stylesheet" />

<style>
    :root {
        --nexp-bg: @bg;
        --nexp-card: @cardBg;
        --nexp-text: @text;
        --nexp-text-soft: @textSoft;
        --nexp-border: @border;
        --nexp-accent: @theme;
        --nexp-font: @font;
        --nexp-fz: @(fz)px;
    }
    .nexp-modal {
        position: fixed;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        font-family: var(--nexp-font);
    }

        .nexp-modal.show {
            display: flex;
        }

    .nexp-modal-backdrop {
        position: absolute;
        inset: 0;
        background: rgba(15, 23, 42, 0.75);
        backdrop-filter: blur(4px);
    }

    .nexp-modal-box {
        position: relative;
        background: var(--nexp-card);
        color: var(--nexp-text);
        border-radius: 18px;
        padding: 24px 24px 20px;
        border: 1px solid var(--nexp-border);
        min-width: 320px;
        max-width: 420px;
        box-shadow: 0 18px 45px rgba(15, 23, 42, 0.6);
        z-index: 1;
    }

    .nexp-modal-title {
        font-size: 1.1rem;
        margin-bottom: 8px;
    }

    .nexp-modal-text {
        font-size: 0.95rem;
        color: var(--nexp-text-soft);
        margin-bottom: 18px;
    }

    .nexp-modal-btn {
        width: 100%;
        justify-content: center;
    }
</style>
<script>
    (function () {
        var hasSuccess = '@(ViewBag.SaveSuccess == true ? "1" : "0")' === '1';
        if (!hasSuccess) return;

        var modal = document.getElementById('nexp-success-modal');
        var btnOk = document.getElementById('nexp-modal-ok');

        if (!modal || !btnOk) return;

        modal.classList.add('show');

        btnOk.addEventListener('click', function () {
            modal.classList.remove('show');
            window.location.href = '@Url.Action("Project", "Expense", new { area = "FN" })';
        });
    })();
</script>