@using System.Collections.Generic
@using QLNSVATC.Models
@model QLNSVATC.Areas.FN.Data.FN_Models.MaterialPurchaseListVM

@{
    Layout = "~/Areas/FN/Views/Shared/_LayoutFN.cshtml";

    var st = ViewBag.Settings as UserViewBagModel;

    string theme = st?.ThemeHex ?? "#22c55e";
    bool dark = st?.DarkMode ?? true;

    string bg = dark ? "#050816" : "#f5f7ff";
    string card = dark ? "#0b0f1b" : "#ffffff";
    string rowEven = dark ? "#101421" : "#f9fafb";
    string text = dark ? "#e5e7eb" : "#020617";
    string textSoft = dark ? "#9ca3af" : "#4b5563";
    string border = dark ? "#272b3a" : "#d1d5db";

    string font = !string.IsNullOrEmpty(st?.FontFamily)
        ? st.FontFamily
        : "Inter, system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif";

    int fz = st?.FontSize ?? 16;

    string lang = ViewBag.CurrentLang as string ?? st?.Lang ?? "en_US";
    ViewBag.CurrentLang = lang;

    Func<Dictionary<string, string>, string> L = d =>
    {
        if (d.ContainsKey(lang)) return d[lang];
        if (d.ContainsKey("en_US")) return d["en_US"];
        return d.Values.First();
    };

    var titleDic = new Dictionary<string, string> {
        { "vi_VN", "Chi phí nhập nguyên vật liệu" },
        { "en_US", "Raw material purchase approvals" },
        { "jp_JP", "原材料仕入れ承認" },
        { "kr_KR", "원자재 구매 승인" },
        { "cn_CN", "原材料采购审批" }
    };

    var subDic = new Dictionary<string, string> {
        { "vi_VN", "Duyệt các đơn mua thép, xi măng, gạch… cho công ty xây dựng" },
        { "en_US", "Review and approve steel, cement and brick purchase requests" },
        { "jp_JP", "鉄筋・セメント・レンガなどの仕入れ申請を管理" },
        { "kr_KR", "철근·시멘트·벽돌 등 원자재 구매 요청을 관리합니다" },
        { "cn_CN", "管理钢筋、水泥、砖块等原材料采购申请" }
    };

    var title = L(titleDic);
    var sub = L(subDic);
}

<div class="mat-root">
    <div class="mat-main">
        <header class="mat-header">
            <div>
                <h2 class="mat-title">@title</h2>
                <p class="mat-sub">@sub</p>
            </div>
            <div class="mat-header-right">
                <div class="mat-pill">
                    <i class="fa-solid fa-user-gear"></i>
                    <span>@string.Format("{0} · {1}px", lang, fz)</span>
                </div>
                <button class="mat-icon-btn js-mat-filter" type="button" title="Filter">
                    <i class="fa-solid fa-filter"></i>
                </button>
                <button class="mat-icon-btn js-mat-more" type="button" title="More actions">
                    <i class="fa-solid fa-ellipsis"></i>
                </button>

                <div class="mat-more-menu" id="matMoreMenu">
                    <a href="@Url.Action("Index", "Expense", new { area = "FN" })">
                        <i class="fa-solid fa-gauge"></i>
                        <span>Back to expense overview</span>
                    </a>
                </div>
            </div>
        </header>

        <div class="mat-filter-bar" id="matFilterBar">
            <div class="mat-filter-inner">
                <div class="mat-filter-group">
                    <label class="mat-filter-label">
                        @L(new Dictionary<string, string>{
                            { "vi_VN", "Tìm kiếm" },
                            { "en_US", "Search" },
                            { "jp_JP", "検索" },
                            { "kr_KR", "검색" },
                            { "cn_CN", "搜索" }
                        })
                    </label>
                    <input id="matFilterKeyword"
                           type="text"
                           class="mat-filter-input"
                           placeholder="@L(new Dictionary<string, string>{
                               { "vi_VN", "Lọc theo từ khóa..." },
                               { "en_US", "Filter by keyword..." },
                               { "jp_JP", "キーワードで絞り込み..." },
                               { "kr_KR", "키워드로 필터링..." },
                               { "cn_CN", "按关键字筛选..." }
                           })" />
                </div>
                <div class="mat-filter-actions">
                    <button type="button" id="matFilterApply" class="mat-filter-btn primary">
                        @L(new Dictionary<string, string>{
                            { "vi_VN", "Áp dụng" },
                            { "en_US", "Apply" },
                            { "jp_JP", "適用" },
                            { "kr_KR", "적용" },
                            { "cn_CN", "应用" }
                        })
                    </button>
                    <button type="button" id="matFilterClear" class="mat-filter-btn ghost">
                        @L(new Dictionary<string, string>{
                            { "vi_VN", "Xóa lọc" },
                            { "en_US", "Clear" },
                            { "jp_JP", "クリア" },
                            { "kr_KR", "초기화" },
                            { "cn_CN", "清除" }
                        })
                    </button>
                </div>
            </div>
        </div>

        <div id="mat-table-wrapper">
            @Html.Partial("_MaterialApprovalsTable", Model.Items)
        </div>
    </div>
</div>
<div class="mat-modal-overlay" id="matModal">
    <div class="mat-modal-dialog">
        <div class="mat-modal-header">
            <h3 class="mat-modal-title" id="matModalTitle">Chi tiết</h3>
            <button type="button" class="mat-modal-close" id="matModalClose">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>

        <div class="mat-modal-body">
            <div class="mat-modal-grid">
                <div class="mat-modal-field">
                    <span class="label">Mã phiếu nhập</span>
                    <span class="value" id="mdRequestCode"></span>
                </div>
                <div class="mat-modal-field">
                    <span class="label">Tên nguyên vật liệu</span>
                    <span class="value" id="mdMaterialName"></span>
                </div>
                <div class="mat-modal-field">
                    <span class="label">Giá trị nhập</span>
                    <span class="value" id="mdAmount"></span>
                </div>
                <div class="mat-modal-field">
                    <span class="label">Ngày nhập</span>
                    <span class="value" id="mdDate"></span>
                </div>
                <div class="mat-modal-field">
                    <span class="label">Mã dự án</span>
                    <span class="value" id="mdProjectCode"></span>
                </div>
                <div class="mat-modal-field">
                    <span class="label">Tên dự án</span>
                    <span class="value" id="mdProjectName"></span>
                </div>
                <div class="mat-modal-field">
                    <span class="label">Trạng thái dự án</span>
                    <span class="value" id="mdProjectStatus"></span>
                </div>
                <div class="mat-modal-field">
                    <span class="label">Hệ số thay đổi</span>
                    <span class="value" id="mdChangeFactor"></span>
                </div>
                <div class="mat-modal-field">
                    <span class="label">Tổng chi phí đã ghi nhận</span>
                    <span class="value" id="mdTotalCost"></span>
                </div>
                <div class="mat-modal-field">
                    <span class="label">Tiền cọc</span>
                    <span class="value" id="mdDeposit"></span>
                </div>
                <div class="mat-modal-field">
                    <span class="label">Doanh thu dự tính nghiệm thu</span>
                    <span class="value" id="mdExpectedRevenue"></span>
                </div>
            </div>

            <p class="mat-modal-warning" id="matModalWarning" style="display:none;">
                Bạn sắp xóa phiếu nhập NVL này. Hành động này sẽ xóa toàn bộ liên kết
                chi phí dự án liên quan và không thể hoàn tác.
            </p>
        </div>

        <div class="mat-modal-footer">
            <button type="button" class="mat-modal-btn ghost" id="matModalCancel">
                Đóng
            </button>
            <button type="button" class="mat-modal-btn danger" id="matModalPrimary" style="display:none;">
                Xóa
            </button>
        </div>
    </div>
</div>
<link rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
      crossorigin="anonymous" referrerpolicy="no-referrer" />

<link href="~/Areas/FN/Data/CSS/Expense/ExpenseMaterial.css" rel="stylesheet" />

<style>
    :root {
        --mat-bg: @bg;
        --mat-card: @card;
        --mat-row-even: @rowEven;
        --mat-text: @text;
        --mat-text-soft: @textSoft;
        --mat-border: @border;
        --mat-accent: @theme;
        --mat-font: @font;
        --mat-fz: @string.Format("{0}px", fz);
    }

    .mat-header-right {
        position: relative;
    }

    .mat-icon-btn {
        cursor: pointer;
    }

    .mat-filter-bar {
        display: none;
        margin-top: 16px;
        margin-bottom: 8px;
        padding: 12px 16px;
        border-radius: 10px;
        background: rgba(15, 23, 42, 0.75);
        border: 1px solid var(--mat-border);
        backdrop-filter: blur(10px);
    }

    .mat-filter-bar.is-open {
        display: block;
    }

    .mat-filter-inner {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        align-items: flex-end;
    }

    .mat-filter-group {
        flex: 1 1 220px;
        min-width: 0;
    }

    .mat-filter-label {
        display: block;
        font-size: 12px;
        font-weight: 500;
        color: var(--mat-text-soft);
        margin-bottom: 4px;
    }

    .mat-filter-input {
        width: 100%;
        padding: 8px 10px;
        border-radius: 8px;
        border: 1px solid var(--mat-border);
        background: rgba(15, 23, 42, 0.85);
        color: var(--mat-text);
        font-size: 13px;
        font-family: var(--mat-font);
        outline: none;
    }

    .mat-filter-input:focus {
        border-color: var(--mat-accent);
        box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.35);
    }

    .mat-filter-actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }

    .mat-filter-btn {
        padding: 8px 14px;
        border-radius: 999px;
        border: 1px solid transparent;
        font-size: 13px;
        font-family: var(--mat-font);
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        transition: all 0.16s ease-out;
    }

    .mat-filter-btn.primary {
        background: linear-gradient(135deg, var(--mat-accent), #22c55e);
        color: #0b1120;
        font-weight: 600;
        border-color: transparent;
    }

    .mat-filter-btn.primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 12px 30px rgba(34, 197, 94, 0.28);
    }

    .mat-filter-btn.ghost {
        background: transparent;
        color: var(--mat-text-soft);
        border-color: var(--mat-border);
    }

    .mat-filter-btn.ghost:hover {
        border-color: var(--mat-accent);
        color: var(--mat-text);
    }

    .mat-more-menu {
        position: absolute;
        top: 40px;
        right: 0;
        min-width: 210px;
        background: var(--mat-card);
        border-radius: 10px;
        border: 1px solid var(--mat-border);
        box-shadow: 0 18px 40px rgba(15, 23, 42, 0.45);
        padding: 6px 0;
        display: none;
        z-index: 30;
    }

    .mat-more-menu.is-open {
        display: block;
    }

    .mat-more-menu a {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        font-size: 13px;
        color: var(--mat-text-soft);
        text-decoration: none;
        font-family: var(--mat-font);
    }

    .mat-more-menu a i {
        font-size: 13px;
        width: 16px;
        text-align: center;
    }

    .mat-more-menu a:hover {
        background: rgba(15, 23, 42, 0.9);
        color: var(--mat-text);
    }

    @@media (max-width: 768px) {
        .mat-filter-inner {
            flex-direction: column;
            align-items: stretch;
        }

        .mat-filter-actions {
            justify-content: flex-start;
        }
    }
</style>

<script>
    (function () {
        var filterBtn = document.querySelector('.js-mat-filter');
        var moreBtn = document.querySelector('.js-mat-more');
        var filterBar = document.getElementById('matFilterBar');
        var moreMenu = document.getElementById('matMoreMenu');
        var applyBtn = document.getElementById('matFilterApply');
        var clearBtn = document.getElementById('matFilterClear');
        var keywordInput = document.getElementById('matFilterKeyword');
        var tableWrapper = document.getElementById('mat-table-wrapper');

        var detailUrl = '@Url.Action("GetMaterialDetail", "Expense", new { area = "FN" })';
        var deleteUrl = '@Url.Action("DeleteMaterial", "Expense", new { area = "FN" })';

        // MODAL
        var modal = document.getElementById('matModal');
        var modalTitle = document.getElementById('matModalTitle');
        var modalWarning = document.getElementById('matModalWarning');
        var modalClose = document.getElementById('matModalClose');
        var modalCancel = document.getElementById('matModalCancel');
        var modalPrimary = document.getElementById('matModalPrimary');

        var mdRequestCode = document.getElementById('mdRequestCode');
        var mdMaterialName = document.getElementById('mdMaterialName');
        var mdAmount = document.getElementById('mdAmount');
        var mdDate = document.getElementById('mdDate');
        var mdProjectCode = document.getElementById('mdProjectCode');
        var mdProjectName = document.getElementById('mdProjectName');
        var mdProjectStatus = document.getElementById('mdProjectStatus');
        var mdChangeFactor = document.getElementById('mdChangeFactor');
        var mdTotalCost = document.getElementById('mdTotalCost');
        var mdDeposit = document.getElementById('mdDeposit');
        var mdExpectedRevenue = document.getElementById('mdExpectedRevenue');

        var currentCode = null;
        var currentProject = null;
        var currentMode = null; // "detail" | "delete"

        if (filterBtn && filterBar) {
            filterBtn.addEventListener('click', function () {
                filterBar.classList.toggle('is-open');
            });
        }

        if (moreBtn && moreMenu) {
            moreBtn.addEventListener('click', function (e) {
                e.stopPropagation();
                moreMenu.classList.toggle('is-open');
            });

            document.addEventListener('click', function () {
                moreMenu.classList.remove('is-open');
            });

            moreMenu.addEventListener('click', function (e) {
                e.stopPropagation();
            });
        }

        function filterRows() {
            if (!tableWrapper || !keywordInput) return;

            var keyword = (keywordInput.value || '').toLowerCase().trim();
            var rows = tableWrapper.querySelectorAll('tbody tr');

            if (!rows || rows.length === 0) return;

            rows.forEach(function (row) {
                var text = (row.innerText || row.textContent || '').toLowerCase();
                if (!keyword) {
                    row.style.display = '';
                } else {
                    row.style.display = text.indexOf(keyword) !== -1 ? '' : 'none';
                }
            });
        }

        if (applyBtn) {
            applyBtn.addEventListener('click', filterRows);
        }

        if (clearBtn) {
            clearBtn.addEventListener('click', function () {
                if (keywordInput) {
                    keywordInput.value = '';
                }
                filterRows();
            });
        }

        if (keywordInput) {
            keywordInput.addEventListener('keydown', function (e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    filterRows();
                }
            });
        }

        function openModal(mode) {
            currentMode = mode || 'detail';

            if (!modal) return;
            modal.classList.add('is-open');

            if (currentMode === 'detail') {
                modalTitle.textContent = 'Chi tiết nhập nguyên vật liệu';
                modalWarning.style.display = 'none';
                modalPrimary.style.display = 'none';
                modalCancel.textContent = 'Đóng';
            } else {
                modalTitle.textContent = 'Xóa phiếu nhập nguyên vật liệu';
                modalWarning.style.display = 'block';
                modalPrimary.style.display = 'inline-flex';
                modalPrimary.textContent = 'Xóa';
                modalCancel.textContent = 'Hủy';
            }
        }

        function closeModal() {
            if (!modal) return;
            modal.classList.remove('is-open');
            currentMode = null;
            currentCode = null;
            currentProject = null;
        }

        [modalClose, modalCancel].forEach(function (btn) {
            if (btn) {
                btn.addEventListener('click', function () {
                    closeModal();
                });
            }
        });

        if (modal) {
            modal.addEventListener('click', function (e) {
                if (e.target === modal) {
                    closeModal();
                }
            });
        }

        function loadDetail(code, project) {
            var url = detailUrl + '?requestCode=' + encodeURIComponent(code) +
                '&projectCode=' + encodeURIComponent(project || '');

            return fetch(url, {
                method: 'GET',
                cache: 'no-cache'
            }).then(function (res) {
                if (!res.ok) throw new Error('Network error');
                return res.json();
            });
        }

        function postForm(url, data) {
            var formData = [];
            for (var key in data) {
                if (data.hasOwnProperty(key)) {
                    formData.push(encodeURIComponent(key) + '=' + encodeURIComponent(data[key]));
                }
            }
            return fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'
                },
                body: formData.join('&')
            }).then(function (res) {
                if (!res.ok) throw new Error('Network error');
                return res.json();
            });
        }

        if (modalPrimary) {
            modalPrimary.addEventListener('click', function () {
                if (currentMode !== 'delete' || !currentCode) return;

                if (!confirm('Bạn chắc chắn muốn xóa phiếu nhập ' + currentCode + ' ?')) {
                    return;
                }

                postForm(deleteUrl, {
                    requestCode: currentCode,
                    projectCode: currentProject || ''
                }).then(function (data) {
                    if (data && data.success) {
                        if (tableWrapper && currentCode) {
                            var row = tableWrapper.querySelector('tr[data-code="' + currentCode.replace(/"/g, '\\"') + '"]');
                            if (row) {
                                row.parentNode.removeChild(row);
                            }
                        }
                        alert(data.message || 'Đã xóa phiếu nhập.');
                        closeModal();
                    } else {
                        alert((data && data.message) || 'Xóa không thành công.');
                    }
                }).catch(function () {
                    alert('Có lỗi khi xóa phiếu nhập.');
                });
            });
        }

        // Click trên bảng
        if (tableWrapper) {
            tableWrapper.addEventListener('click', function (e) {
                var viewBtn = e.target.closest('.js-mat-view');
                var deleteBtn = e.target.closest('.js-mat-delete');

                if (!viewBtn && !deleteBtn) return;

                var row = e.target.closest('tr');
                if (!row) return;

                var code = row.getAttribute('data-code');
                var project = row.getAttribute('data-project') || '';

                if (!code) return;

                currentCode = code;
                currentProject = project;

                if (viewBtn) {
                    loadDetail(code, project).then(function (data) {
                        if (!data || !data.success) {
                            alert((data && data.message) || 'Không tải được chi tiết.');
                            return;
                        }

                        mdRequestCode.textContent = data.code || '';
                        mdMaterialName.textContent = data.materialName || '';
                        mdAmount.textContent = data.amountText || '';
                        mdDate.textContent = data.date || '';
                        mdProjectCode.textContent = data.projectCode || '';
                        mdProjectName.textContent = data.projectName || '';
                        mdProjectStatus.textContent = data.projectStatus || '';
                        mdChangeFactor.textContent = data.changeFactorText || '';
                        mdTotalCost.textContent = data.totalCostText || '';
                        mdDeposit.textContent = data.depositText || '';
                        mdExpectedRevenue.textContent = data.expectedRevenueText || '';

                        openModal('detail');
                    }).catch(function () {
                        alert('Có lỗi khi tải chi tiết phiếu nhập.');
                    });

                    return;
                }

                if (deleteBtn) {
                    loadDetail(code, project).then(function (data) {
                        if (!data || !data.success) {
                            alert((data && data.message) || 'Không tải được thông tin để xóa.');
                            return;
                        }

                        mdRequestCode.textContent = data.code || '';
                        mdMaterialName.textContent = data.materialName || '';
                        mdAmount.textContent = data.amountText || '';
                        mdDate.textContent = data.date || '';
                        mdProjectCode.textContent = data.projectCode || '';
                        mdProjectName.textContent = data.projectName || '';

                        mdProjectStatus.textContent = data.projectStatus || '';
                        mdChangeFactor.textContent = data.changeFactorText || '';
                        mdTotalCost.textContent = data.totalCostText || '';
                        mdDeposit.textContent = data.depositText || '';
                        mdExpectedRevenue.textContent = data.expectedRevenueText || '';

                        openModal('delete');
                    }).catch(function () {
                        alert('Có lỗi khi tải thông tin để xóa.');
                    });

                    return;
                }
            });
        }
    })();
</script>
