@model IEnumerable<QLNSVATC.Models.MENU>

@{
    var menus = Model.ToList();
    var roots = menus.Where(x => x.ParentId == null).OrderBy(x => x.OrderNumber).ToList();

    string themeColor = ViewBag.ThemeColor as string ?? "#121212";
    string fontFamily = ViewBag.FontFamily as string ?? "Inter";
    int fontSize = ViewBag.FontSize != null ? (int)ViewBag.FontSize : 14;
    string currentLang = ViewBag.CurrentLang as string ?? "vi_VN";
    bool isDarkMode = ViewBag.DarkMode != null ? (bool)ViewBag.DarkMode : false;

    string textColor = isDarkMode ? "#ffffff" : "#000000";
    string gradient1 = isDarkMode ? "#000000" : "#ffffff";
    string gradient2 = isDarkMode ? "#ffffff" : "#000000";
    string gradientDirection = isDarkMode ? "to left" : "to right";

    string userName = Session["FullName"] as string ?? null;

    var langAccount = new Dictionary<string, string>
{
        { "vi_VN", userName == null ? "TÀI KHOẢN" : $"XIN CHÀO, {userName.ToUpper()}" },
        { "en_US", userName == null ? "ACCOUNT" : $"HELLO, {userName.ToUpper()}" },
        { "jp_JP", userName == null ? "アカウント" : $"こんにちは, {userName}" },
        { "kr_KR", userName == null ? "계정" : $"환영합니다, {userName}" },
        { "cn_CN", userName == null ? "账户" : $"您好, {userName}" }
    };

    var langLogin = new Dictionary<string, string>
{
        { "vi_VN", "Đăng nhập" },
        { "en_US", "Login" },
        { "jp_JP", "ログイン" },
        { "kr_KR", "로그인" },
        { "cn_CN", "登录" }
    };

    var langRegister = new Dictionary<string, string>
{
        { "vi_VN", "Đăng ký" },
        { "en_US", "Register" },
        { "jp_JP", "新規登録" },
        { "kr_KR", "회원가입" },
        { "cn_CN", "注册" }
    };

    var langProfile = new Dictionary<string, string>
{
        { "vi_VN", "Hồ sơ" },
        { "en_US", "Profile" },
        { "jp_JP", "プロフィール" },
        { "kr_KR", "프로필" },
        { "cn_CN", "资料" }
    };

    var langLogout = new Dictionary<string, string>
{
        { "vi_VN", "Đăng xuất" },
        { "en_US", "Logout" },
        { "jp_JP", "ログアウト" },
        { "kr_KR", "로그아웃" },
        { "cn_CN", "退出登录" }
    };

    string accountLabel = langAccount[currentLang];
    string loginLabel = langLogin[currentLang];
    string registerLabel = langRegister[currentLang];
    string profileLabel = langProfile[currentLang];
    string logoutLabel = langLogout[currentLang];
}

<style>
    :root {
    --text-color: @textColor;
    --theme-color: @themeColor;
    --font: @fontFamily, sans-serif;
    --fz: @(fontSize)px;
    --g1: @gradient1;
    --g2: @gradient2;
    --gd: @gradientDirection;
    }

    /* NAVBAR */
    nav {
/*        overflow-x: hidden;*/
/*        overflow-y: hidden;*/
        background: var(--theme-color);
        padding: 12px 0;
        box-shadow: 0 6px 18px rgba(0,0,0,.12);
        position: relative;
        z-index: 9999;
    }

    .nav-inner {
/*        max-width: 1200px;*/
/*        margin: auto;*/
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 20px;
        height: 58px;
        white-space: nowrap;
    }

    .navbar-brand {
        align-items: center;
        font-size: 1.6em;
        font-weight: 700;
        color: var(--text-color);
        text-decoration: none;
        user-select: none;
    }

    /* MENU */
    .main-menu {
        list-style: none;
        display: flex;
        gap: 22px;
        align-items: center;
    }

    .main-menu > li {
        position: relative;
    }

    .main-menu > li > a {
        position: relative;
        padding: 12px 14px;
        color: var(--text-color);
        font-weight: 700;
        text-transform: uppercase;
        font-size: var(--fz);
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        transition: .25s;
    }

    .main-menu > li > a:hover {
        text-shadow: 0 0 8px var(--g1), 0 0 15px var(--g1);
    }

    .main-menu > li > a::after {
        content: "";
        position: absolute;
        bottom: 2px;
        left: 0;
        width: 100%;
        height: 3px;
        background: linear-gradient(var(--gd), var(--g1), var(--g2));
        border-radius: 50px;
        opacity: 0;
        transform: scaleX(0);
        transform-origin: left center;
        transition: .25s;
    }

    .main-menu > li > a:hover::after {
        opacity: 1;
        transform: scaleX(1);
    }

    /* DROPDOWN */
    .dropdown-menu {
        position: absolute;
        top: 100%;
        left: 0;
        min-width: 180px;
        padding: 6px 0 10px;
        border-radius: 8px;
        background: #1a1c22;
        display: none;
        box-shadow: 0 10px 20px rgba(0,0,0,.35);
        z-index: 10000;
        margin-top: 2px;
    }

    .main-menu > li:hover > .dropdown-menu,
    .dropdown-menu:hover {
        display: block;
    }

    .dropdown-menu a {
        padding: 8px 16px;
        display: block;
        color: #e2e6ff;
        text-decoration: none;
        white-space: nowrap;
        transition: .2s;
    }

    .dropdown-menu a:hover {
        background: rgba(255,255,255,0.08);
        text-shadow: 0 0 6px #fff;
    }

    /* MOBILE */
    .menu-toggle {
/*        overflow-x: hidden;*/
        display: none;
        font-size: 32px;
        color: var(--text-color);
        cursor: pointer;
        background: var(--theme-color);
        padding: 4px 10px;
        border-radius: 6px;
    }
    @@media (max-width:1200px) {
        nav {
            width: 100vw;
            width: 100%;
        }
        .nav-inner {
            padding: 0 12px;
        }

        .menu-toggle {
            display: block;
            position: relative;
            margin-right: -30px;
            transform: translateX(-100%);
            width:70px;
        }

        .main-menu {
            overflow-x: hidden;
            flex-direction: column;
            align-items: flex-start;
            position: fixed;
            top: 82px;
            left: -60%;
            width: 55%;
            height: 100vh;
            background: var(--theme-color);
            padding-top: 80px;
            padding-left: 24px;
            transition: .35s;
            gap: 0;
            overflow-y: auto;
        }
        nav.open .main-menu {
            left: 0;
        }

        .main-menu > li > a {
            justify-content: flex-start;
            text-align: left;
            width: 100%;
            padding: 13px 13px;
            color: var(--text-color);
        }

        .dropdown-menu {
            position: relative;
            display: none;
            top: 0;
            left: 0;
            background: var(--theme-color);
            color: var(--text-color);
            box-shadow: none;
            margin-top: -20px;
            padding: 4px 0 4px 16px;
        }

        .dropdown-menu a {
            padding: 6px 6px;
            color: var(--text-color);
        }

        .dropdown-menu a:hover {
            background: rgba(255,255,255,0.12);
            text-shadow: 0 0 6px var(--text-color);
        }

    }

    /* SETTINGS */
    .settings-btn {
        font-size: 22px;
        cursor: pointer;
        color: var(--text-color);
        user-select: none;
        transition: .2s;
        margin-left:10px;
    }

        .settings-btn:hover {
            animation: spinSlow 1s linear forwards;
        }


        @@keyframes spinSlow {
            from { transform: rotate(0deg); }
            to   { transform: rotate(720deg); }
        }
    @@media (max-width:1200px) {
        .settings-btn:hover {
            animation:none;
            transform: scale(0.9)
        }
    }
    .settings-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.55);
        display: none;
        z-index: 6000;
    }

    .settings-overlay.show {
        display: block;
    }

    .settings-panel {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(.9);
        width: 330px;
        max-width: 95%;
        background: #11141f;
        border-radius: 18px;
        padding: 24px 26px;
        display: none;
        z-index: 7000;
        transition: .25s;
        box-shadow: 0 18px 45px rgba(0,0,0,0.4);
        color: #f5f5ff;
    }

    .settings-panel.show {
        display: block;
        transform: translate(-50%, -50%) scale(1);
    }

    /* SETTINGS FORM */
    .settings-panel form {
        display: flex;
        flex-direction: column;
        gap: 14px;
    }

    .settings-title {
        font-size: 20px;
        font-weight: 700;
        text-align: center;
        margin-bottom: 6px;
    }

    .settings-row {
        display: flex;
        flex-direction: column;
    }

    .settings-label {
        font-weight: 600;
        margin-bottom: 4px;
        font-size: 14px;
    }

    .settings-input {
        width: 100%;
        padding: 8px 10px;
        border-radius: 10px;
        background: #1a1e2b;
        border: 1px solid rgba(255,255,255,0.15);
        color: #f5f5ff;
        font-size: 14px;
    }

    .settings-input:focus {
        border-color: #40c9ff;
        outline: none;
        box-shadow: 0 0 0 1px #40c9ff;
    }

    .settings-save {
        width: 100%;
        padding: 10px 0;
        margin-top: 4px;
        background: linear-gradient(135deg, #0d6efd, #40c9ff);
        border-radius: 999px;
        border: none;
        color: #fff;
        font-size: 16px;
        cursor: pointer;
        font-weight: 600;
    }

    .settings-save:hover {
        opacity: .9;
    }

    /* POPUP */
    .msg-popup {
        position: fixed;
        top: -80px;
        left: 50%;
        transform: translateX(-50%);
        background: #222;
        color: #fff;
        padding: 14px 22px;
        border-radius: 8px;
        font-size: 15px;
        font-weight: 600;
        box-shadow: 0 6px 18px rgba(0,0,0,0.2);
        z-index: 9999;
        opacity: 0;
        transition: .35s;
    }

    .msg-popup.show {
        top: 20px;
        opacity: 1;
    }

    .msg-popup.success {
        background: #28a745;
    }

    .msg-popup.error {
        background: #dc3545;
    }
    body.blur-active {
        filter: blur(4px);
        transition: .25s;
    }
    #logo {
        height: 100%;
        max-height: 58px;
        width:auto;
    }
    ul.main-menu {
        margin: 0 !important;
        padding: 0 !important;
    }
</style>

<nav class="nav-neon">
    <div id="msgPopup" class="msg-popup"></div>

    <div class="nav-inner">

        <a class="navbar-brand" href="/">
            <img id="logo" src="~/Content/Images/mainbg.png"
                 style="margin-right:8px;vertical-align:middle;" />
            MySite
        </a>


        <div class="menu-toggle" onclick="document.querySelector('nav').classList.toggle('open')">☰</div>

        <ul class="main-menu">

            @foreach (var root in roots)
            {
                var children = menus.Where(c => c.ParentId == root.MenuId).OrderBy(c => c.OrderNumber).ToList();

                if (children.Any())
                {
                    <li>
                        <a href="@root.MenuLink">@root.MenuName</a>
                        <ul class="dropdown-menu">
                            @foreach (var child in children)
                            {
                                <li><a href="@child.MenuLink">@child.MenuName</a></li>
                            }
                        </ul>
                    </li>
                }
                else
                {
                    <li><a href="@root.MenuLink">@root.MenuName</a></li>
                }
            }

            <!-- Account -->
            <li>
                <a href="#">@accountLabel</a>
                <ul class="dropdown-menu">
                    @if (userName == null)
                    {
                        <li>@Html.ActionLink(loginLabel, "Login", "Account")</li>
                        <li>@Html.ActionLink(registerLabel, "Register", "Account")</li>
                    }
                    else
                    {
                        <li>@Html.ActionLink(profileLabel, "Profile", "Account")</li>
                        <li>@Html.ActionLink(logoutLabel, "Logout", "Account", new { area = "" }, new { })</li>
                    }
                </ul>
            </li>

            <!-- Setting -->
            <li class="settings-btn" onclick="openSettingCheck()">⚙</li>

        </ul>

        <!-- Setting -->
        <div id="settingsOverlay" class="settings-overlay" onclick="closeSettingsPanel()"></div>

        <div id="settingsPanel" class="settings-panel" onclick="event.stopPropagation()">

            <h2 class="settings-title">UI SETTING</h2>

            <form action="/Shared/SaveSettings" method="post">

                <label>Theme Color</label>
                <input type="color" name="ThemeColor" class="settings-input" value="@themeColor" />

                <label>Dark Mode</label>
                <select name="Type" class="settings-input">
                    <option value="true" @(isDarkMode ? "selected" : "")>Black</option>
                    <option value="false" @(!isDarkMode ? "selected" : "")>White</option>
                </select>

                <label>Language</label>
                <select name="LanguageCode" class="settings-input">
                    <option value="vi_VN" @(currentLang == "vi_VN" ? "selected" : "")>Việt Nam</option>
                    <option value="en_US" @(currentLang == "en_US" ? "selected" : "")>English</option>
                    <option value="jp_JP" @(currentLang == "jp_JP" ? "selected" : "")>日本語</option>
                    <option value="kr_KR" @(currentLang == "kr_KR" ? "selected" : "")>한국어</option>
                    <option value="cn_CN" @(currentLang == "cn_CN" ? "selected" : "")>中文</option>
                </select>

                <label>Font family</label>
                <select name="FontCode" class="settings-input">
                    <option value="inter">Inter</option>
                    <option value="arial">Arial</option>
                    <option value="roboto">Roboto</option>
                </select>

                <label>Text size</label>
                <input type="number" name="FontSize" class="settings-input" min="10" max="24" value="@fontSize" />

                <button type="submit" class="settings-save">Lưu thay đổi</button>

            </form>
        </div>

    </div>
</nav>

<script>
    function openSettingsPanel() {
        document.getElementById("settingsOverlay").classList.add("show");
        document.getElementById("settingsPanel").classList.add("show");
    }

    function closeSettingsPanel() {
        document.getElementById("settingsOverlay").classList.remove("show");
        document.getElementById("settingsPanel").classList.remove("show");
    }
    document.querySelectorAll(".main-menu > li > a").forEach(link => {

        link.addEventListener("click", function (e) {
            if (window.innerWidth > 1200) return;
            const li = this.parentElement;
            const submenu = li.querySelector(".dropdown-menu");
            if (!submenu) return;
            e.preventDefault();
            e.stopPropagation()
            document.querySelectorAll(".dropdown-menu").forEach(menu => {
                if (menu !== submenu) menu.style.display = "none";
            });
            submenu.style.display =
                submenu.style.display === "block" ? "none" : "block";
        });
    });

    document.addEventListener("click", function () {
        if (window.innerWidth > 1200) return;
        document.querySelectorAll(".dropdown-menu")
            .forEach(menu => menu.style.display = "none");
    });
    function openSettingCheck() {
        var user = "@(Session["UserId"] ?? "")";
        if (!user || user.trim() === "") {
            window.location.href = "/Account/Login?returnUrl=/";
            return;
        }
        openSettingsPanel();
    }

    function showPopup(type, message) {
        const popup = document.getElementById("msgPopup");
        popup.className = "msg-popup " + type + " show";
        popup.innerText = message;
        setTimeout(() => popup.classList.remove("show"), 2500);
    }
</script>

